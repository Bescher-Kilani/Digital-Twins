services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: digitwin-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-password123}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-digitwin}
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    networks:
      - digitwin-network
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Keycloak Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.2
    container_name: digitwin-keycloak
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      KC_DB: dev-file
      KC_DB_URL_DATABASE: /opt/keycloak/data/keycloak
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./keycloak-import:/opt/keycloak/data/import
    command: ["start-dev", "--import-realm"]
    networks:
      - digitwin-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/realms/master"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Backend Service
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile.local
    container_name: digitwin-backend
    environment:
      MONGODB_URI: mongodb://${MONGODB_ROOT_USERNAME:-admin}:${MONGODB_ROOT_PASSWORD:-password123}@mongodb:27017/${MONGODB_DATABASE:-digitwin}?authSource=admin
      MONGODB_DATABASE: ${MONGODB_DATABASE:-digitwin}
      SPRING_PROFILES_ACTIVE: docker
      # Keycloak URLs using service name
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/DigiTwinStudio
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/DigiTwinStudio/protocol/openid-connect/certs
    ports:
      - "${BACKEND_PORT:-9090}:9090"
    depends_on:
      keycloak:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - digitwin-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Frontend Service
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile.local
    container_name: digitwin-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      backend:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - digitwin-network
    restart: unless-stopped

networks:
  digitwin-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  keycloak_data:
    driver: local